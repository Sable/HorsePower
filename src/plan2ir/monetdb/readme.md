# A Plan-to-HorseIR Translator for MonetDB's Plans

## Overview

database system

    MonetDB

query

    TPC-H or AIDA

main script

    ./run.sh    ## shows usage

input/query
    
    - includes standard sql queries from tpch/aida/udf

input/plan

    - includes plans generated by using queries in MonetDB

output

    - includes HorseIR programs generated by different kinds of plans

commands for plans

    - dump: show JSON objects
    - show: show operators only
    - dot : create a dot diagram for operators


## Step to Setup

1 Fetch execution plans from MonetDB
    
    mclient -d tpch1 -f raw input/query/tpch/q6.sql > input/plan/tpch/q6.plan

2 Translate plans to HorseIR code and save to `output`

    ./run.sh tpch 6      > output/tpch/q6.hir    ## tpch
    ./run.sh aida <name> > output/aida/name.hir  ## aida
    ./run.sh udf  <name> > output/udf/name.hir   ## udf

3 List all scripts under folder

    ./run.sh ls tpch
    ./run.sh ls aida
    ./run.sh ls udf


## Kinds of Queries

### TPC-H Queries


### AIDA Queries


### Queries with User-defined Functions

***Note*** that examples are from the Froid paper.

Derived query 6

	-- query 6
	select
		   sum(l_extendedprice*l_discount) as revenue
	from
		   lineitem
	where
           q6_cond_proc(l_shipdate, l_quantity, l_discount)
	;

Procedure defined in the WHERE clause

	-- procedure
	CREATE OR REPLACE FUNCTION q6_cond_proc(shipdate date, quantity float, discount float)
	RETURNS boolean
	BEGIN
	   declare date1 date;
	   declare date2 date;
	   set date1 = '1994-01-01';
	   set date2 = '1995-01-01';
	   IF (quantity >= 24)
	   THEN RETURN 0;
	   END IF;
	   IF (shipdate < date1)
	   THEN RETURN 0;
	   END IF;
	   IF (shipdate >= date2)
	   THEN RETURN 0;
	   END IF;
	   IF (discount < 0.05)
	   THEN RETURN 0;
	   END IF;
	   IF (discount > 0.07)
	   THEN RETURN 0;
	   END IF;
	   RETURN 1;
	END;

Execution plans fetched

    ./run.sh plan q6_proc | mclient -i -d tpch1 -f raw > input/plan/udf/q6_proc.plan

Run translator to generate HorseIR code (key)

    ./run.sh udf q6_proc

SQL to plan

    cp /mnt/local/tpch_2_17_0/chf/myqueries/6.sql ./input/query
    // modify q6

    // get its execution plan
    echo "PLAN `cat input/query/6.sql`" | mclient -i -d tpch1 -f raw

    // get its HorseIR code
    echo "PLAN `cat input/query/6.sql`" | mclient -i -d tpch1 -f raw | python m2ir.py

