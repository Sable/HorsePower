# TPC-H Query 9

## SQL

```sql
  select
    nation,
    o_year,
    sum(amount) as sum_profit
  from
    (
      select
        n_name as nation,
        extract(year from o_orderdate) as o_year,
        l_extendedprice * (1 - l_discount) - ps_supplycost * l_quantity as amount
      from
        part,
        supplier,
        lineitem,
        partsupp,
        orders,
        nation
      where
        s_suppkey = l_suppkey
        and ps_suppkey = l_suppkey
        and ps_partkey = l_partkey
        and p_partkey = l_partkey
        and o_orderkey = l_orderkey
        and s_nationkey = n_nationkey
        and p_name like '%green%'
    ) as profit
  group by
    nation,
    o_year
  order by
    nation,
    o_year desc;
```

## HorseIR

```
import Bultin;

module default{
    def createTableProfit() : table{
        // step 0: load table
        a0:table = @load_table(`part);
        a1:table = @load_table(`supplier);
        a2:table = @load_table(`lineitem);
        a3:table = @load_table(`partsupp);
        a4:table = @load_table(`orders);
        a5:table = @load_table(`nation);

        t0:i64 = check_cast(@column_value(a1, `s_suppkey)      , i64);
        t1:i64 = check_cast(@column_value(a2, `l_suppkey)      , i64);
        t2:i64 = check_cast(@column_value(a0, `p_partkey)      , i64);
        t3:i64 = check_cast(@column_value(a2, `l_partkey)      , i64);
        t4:sym = check_cast(@column_value(a0, `p_name)         , sym);
        t5:f64 = check_cast(@column_value(a2, `l_extendedprice), f64);
        t6:f64 = check_cast(@column_value(a2, `l_discount)     , f64);
        t7:f64 = check_cast(@column_value(a2, `l_quantity)     , f64);
        t8:f64 = check_cast(@column_value(a3, `ps_supplycost)  , f64);
        t9:f64 = check_cast(@column_value(a4, `o_orderdate)    , f64);

        // step 1: where clause
        e0:enum<?> = @load_fkey(a2, (`l_suppkey,`l_partkey):sym);
        e1:enum<?> = @load_fkey(a2, `l_orderkey);
        e2:enum<?> = @load_fkey(a1, `s_nationkey);
        e3:enum<?> = @enum(t0,t1);
        e4:enum<?> = @enum(t2,t3);

        w0:bool    = @like(t4, "%green%");
        w1:sym     = @compress(w0,t4);
        w2:i64     = @index_of(w1,t3);  //e4: l
        w3:i64     = @len(t3);
        w4:bool    = @lt(w2,t3);
        w5:enum    = @compress(w4,e0);  //e0: ps
        w6:enum    = @compress(w4,e1);  //e1: o
        w7:sym     = @compress(w4,w1);
        w8:enum    = @enum(t0,w7);      //e3
        w9:i64     = @to_index(w8);
        w10:enum   = @index(e2,w9);     //e2

        // step 2: group by <no>
        // step 3: select
        s0:i64     = @value(w10);
        s1:i64     = @to_index(w6);
        s90:i64    = @index(t9,s1);    // (s90: a fix)
        s2:i64     = @date_year(s90);
        s3:f64     = @compress(w4,t5); // l_extendedprice
        s4:f64     = @compress(w4,t6); // l_discount
        s5:f64     = @compress(w4,t7); // l_quantity
        s6:f64     = @sub(1,s3);
        s7:f64     = @mul(s4,s6);
        s8:i64     = @to_index(w5);
        s9:f64     = @index(t8,s8);    // ps_supplycost
        s10:f64    = @mul(s9,s5);
        s11:f64    = @minus(s7,s10);   // as amount

        // step 4: order by <no>
        // step 5: materialization
        m0:i64       = s0;
        m1:i64       = s2;
        m2:f64       = s11;

        z0:sym       = (`nation,`o_year,`amount):sym;
        z1:list<sym> = @tolist(z0);
        z2:list<?>   = @list(m0,m1,m2);
        z:table      = @table(z1,z2);
    }

    def main() : table{
        // step 0: load table
        a0:table = @createTableProfit();

        t0:sym = check_cast(@column_value(a0, `nation), sym);
        t1:d   = check_cast(@column_value(a0, `o_year), d  );
        t2:f64 = check_cast(@column_value(a0, `amount), f64);

        // step 1: where clause <no>
        // step 2: group by
        g0:list<?> = @list(t0,t1);
        g1:dict<list<?>,list<i64>> = @group(g0);

        // step 3: select
        s0:list<?>   = @key(g1);
        s1:sym       = check_cast(@index(s0,0), sym); //unravel
        s2:d         = check_cast(@index(s0,1), d  );
        s3:list<i64> = @value(g1);
        s4:list<f64> = @each_right(@index,t2,s3);
        s5:list<f64> = @each(@sum, s4);
        s6:f64       = @raze(s5);

        // step 4: order by
        r0:list<?>   = @list(s1,s2);
        r1:bool      = (1,0):bool;
        r2:i64       = @order(r0,r1);

        // step 5: materialization
        m0:sym       = @index(s1,r2);
        m1:d         = @index(s2,r2);
        m2:f64       = @index(s3,r2);

        z0:sym       = (`nation,`o_year,`sum_profit):sym
        z1:list<sym> = @tolist(z0);
        z2:list<?>   = @list(m0,m1,m2);
        z:table      = @table(z1,z2);
        return z;
   }
}
```

